<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>kubeadm搭建k8s 1.18 - Hailan Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hailan Blog"><meta name="msapplication-TileImage" content="/img/logo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hailan Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description="本文主要介绍k8s搭建，使用官方推荐工具kubeadm进行搭建，ETCD独立部署"><meta property="og:type" content="blog"><meta property="og:title" content="kubeadm搭建k8s 1.18"><meta property="og:url" content="https://guohailan.github.io/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/"><meta property="og:site_name" content="Hailan Blog"><meta property="og:description" content="本文主要介绍k8s搭建，使用官方推荐工具kubeadm进行搭建，ETCD独立部署"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://guohailan.github.io/thumbnail/k8s.jpg"><meta property="article:published_time" content="2020-08-20T12:58:38.000Z"><meta property="article:modified_time" content="2020-10-20T12:31:04.259Z"><meta property="article:author" content="guohailan"><meta property="article:tag" content="k8s"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/thumbnail/k8s.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://guohailan.github.io/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/"},"headline":"Hailan Blog","image":["https://guohailan.github.io/thumbnail/k8s.jpg"],"datePublished":"2020-08-20T12:58:38.000Z","dateModified":"2020-10-20T12:31:04.259Z","author":{"@type":"Person","name":"Guo Hailan"},"description":"本文主要介绍k8s搭建，使用官方推荐工具kubeadm进行搭建，ETCD独立部署"}</script><link rel="canonical" href="https://guohailan.github.io/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/"><link rel="alternate" href="/atom.xml" title="Hailan Blog" type="application/atom+xml"><link rel="icon" href="/img/logo.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/monokai.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css"><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><meta name="generator" content="Hexo 5.0.2"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/blog.png" alt="Hailan Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/guohailan"><i class="fab fa-github"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on Gitee" href="https://gitee.com/guohailan"><i class="fab fa-github-alt"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/thumbnail/k8s.jpg" alt="kubeadm搭建k8s 1.18"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-08-20T12:58:38.000Z" title="2020-08-20T12:58:38.000Z">2020-08-20</time>发表</span><span class="level-item"><time dateTime="2020-10-20T12:31:04.259Z" title="2020-10-20T12:31:04.259Z">2020-10-20</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span> / </span><a class="link-muted" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/K8S/">K8S</a></span><span class="level-item">7 分钟读完 (大约1033个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">kubeadm搭建k8s 1.18</h1><div class="content"><p>本文主要介绍k8s搭建，使用官方推荐工具kubeadm进行搭建，ETCD独立部署</p>
<a id="more"></a>
<h2 id="docker-安装"><a href="#docker-安装" class="headerlink" title="docker 安装"></a>docker 安装</h2><p>添加阿里镜像源地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<p>安装docker出现如下错误,当前服务器上安装的containerd.io版本为1.2.0-3.el7版本过低</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@guohailan3 ~]<span class="comment"># yum -y install docker-ce</span></span><br><span class="line">上次元数据过期检查：0:00:07 前，执行于 2020年05月24日 星期日 03时42分48秒。</span><br><span class="line">错误：</span><br><span class="line"> 问题: package docker-ce-3:19.03.9-3.el7.x86_64 requires containerd.io &gt;= 1.2.2-3, but none of the providers can be installed</span><br><span class="line">  - cannot install the best candidate <span class="keyword">for</span> the job</span><br><span class="line">  - package containerd.io-1.2.10-3.2.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.13-3.1.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.13-3.2.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.2-3.3.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.2-3.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.4-3.1.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.5-3.1.el7.x86_64 is excluded</span><br><span class="line">  - package containerd.io-1.2.6-3.3.el7.x86_64 is excluded</span><br><span class="line">(尝试添加 <span class="string">&#x27;--skip-broken&#x27;</span> 来跳过无法安装的软件包 或 <span class="string">&#x27;--nobest&#x27;</span> 来不只使用最佳选择的软件包)</span><br></pre></td></tr></table></figure>

<p>升级containerd.io，再次进行安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.docker.com/linux/centos/7/x86_64/edge/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm</span><br><span class="line">yum install containerd.io-1.2.6-3.3.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>配置开机启动和启动docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<p>优化docker参数</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/">官方文档</a>表示，更改设置，令容器运行时和kubelet使用systemd作为cgroup驱动，以此使系统更为稳定。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tee /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://bk6kzfqm.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">  <span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">  <span class="string">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">  <span class="string">&quot;log-opts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max-size&quot;</span>: <span class="string">&quot;100m&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl daemon-reload <span class="comment"># 重新加载</span></span><br><span class="line">systemctl restart docker <span class="comment"># 重启docker</span></span><br></pre></td></tr></table></figure>

<h2 id="kubernet-安装"><a href="#kubernet-安装" class="headerlink" title="kubernet 安装"></a>kubernet 安装</h2><h3 id="安装kubectl"><a href="#安装kubectl" class="headerlink" title="安装kubectl"></a>安装kubectl</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#无法连接google，配置了阿里的源</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">yum install -y kubectl</span><br><span class="line"></span><br><span class="line">setenforce 0 <span class="comment">#暂时关闭selinux</span></span><br><span class="line">sed -i <span class="string">&#x27;s/SELINUX=permissive/SELINUX=disabled/&#x27;</span> /etc/sysconfig/selinux <span class="comment">#Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。</span></span><br><span class="line">swapoff -a</span><br><span class="line">yum install -y kubeadm kubelet <span class="comment">#安装kubeadm kubelet工具</span></span><br></pre></td></tr></table></figure>

<h3 id="准备证书"><a href="#准备证书" class="headerlink" title="准备证书"></a>准备证书</h3><p>证书需要在一台机器上生成，拷贝到别的机器上</p>
<h4 id="准备证书管理工具"><a href="#准备证书管理工具" class="headerlink" title="准备证书管理工具"></a>准备证书管理工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/bin/cfssl</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x cfssljson_linux-amd64</span><br><span class="line">mv cfssljson_linux-amd64 /usr/bin/cfssljson</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>

<h4 id="生成ETCD的TLS-秘钥和证书"><a href="#生成ETCD的TLS-秘钥和证书" class="headerlink" title="生成ETCD的TLS 秘钥和证书"></a>生成ETCD的TLS 秘钥和证书</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 CA 配置文件</span></span><br><span class="line">mkdir ssl &amp;&amp; <span class="built_in">cd</span> ssl</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br><span class="line">cat &gt; config.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">&quot;signing&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;default&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;expiry&quot;: &quot;8760h&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">    &quot;profiles&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;kubernetes&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;usages&quot;: [</span></span><br><span class="line"><span class="string">            &quot;signing&quot;,</span></span><br><span class="line"><span class="string">            &quot;key encipherment&quot;,</span></span><br><span class="line"><span class="string">            &quot;server auth&quot;,</span></span><br><span class="line"><span class="string">            &quot;client auth&quot;</span></span><br><span class="line"><span class="string">        ],</span></span><br><span class="line"><span class="string">        &quot;expiry&quot;: &quot;8760h&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>config.json：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li>signing：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</li>
<li>server auth：表示 client 可以用该 CA 对 server 提供的证书进行验证；</li>
<li>client auth：表示 server 可以用该 CA 对 client 提供的证书进行验证；</li>
</ul>
<h4 id="创建ca证书请求"><a href="#创建ca证书请求" class="headerlink" title="创建ca证书请求"></a>创建ca证书请求</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class="line"><span class="string">    &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">        &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;names&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">            &quot;L&quot;: &quot;GuangDong&quot;,</span></span><br><span class="line"><span class="string">            &quot;ST&quot;: &quot;ShenZhen&quot;,</span></span><br><span class="line"><span class="string">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class="line"><span class="string">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
<h4 id="创建CA证书和私钥"><a href="#创建CA证书和私钥" class="headerlink" title="创建CA证书和私钥"></a>创建CA证书和私钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure>

<h4 id="创建-etcd-证书签名请求"><a href="#创建-etcd-证书签名请求" class="headerlink" title="创建 etcd 证书签名请求"></a>创建 etcd 证书签名请求</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-csr.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;CN&quot;: &quot;etcd&quot;,</span></span><br><span class="line"><span class="string">  &quot;hosts&quot;: [</span></span><br><span class="line"><span class="string">    &quot;192.168.31.48&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.31.137&quot;,</span></span><br><span class="line"><span class="string">    &quot;192.168.31.226&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class="line"><span class="string">    &quot;size&quot;: 2048</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;names&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="string">      &quot;ST&quot;: &quot;GuangDong&quot;,</span></span><br><span class="line"><span class="string">      &quot;L&quot;: &quot;ShenZhen&quot;,</span></span><br><span class="line"><span class="string">      &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class="line"><span class="string">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>hosts 字段指定授权使用该证书的 etcd 节点 IP；</li>
<li>每个节点IP 都要在里面 或者 每个机器申请一个对应IP的证书</li>
</ul>
<h4 id="生成-etcd-证书和私钥"><a href="#生成-etcd-证书和私钥" class="headerlink" title="生成 etcd 证书和私钥"></a>生成 etcd 证书和私钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem \</span><br><span class="line">  -ca-key=ca-key.pem \</span><br><span class="line">  -config=config.json \</span><br><span class="line">  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure>

<h4 id="将证书拷贝到所有服务器的指定目录"><a href="#将证书拷贝到所有服务器的指定目录" class="headerlink" title="将证书拷贝到所有服务器的指定目录"></a>将证书拷贝到所有服务器的指定目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/etcd/ssl</span><br><span class="line">cp etcd.pem etcd-key.pem  ca.pem /etc/etcd/ssl/</span><br></pre></td></tr></table></figure>

<h3 id="安装ETCD"><a href="#安装ETCD" class="headerlink" title="安装ETCD"></a>安装ETCD</h3><h4 id="准备二进制文件"><a href="#准备二进制文件" class="headerlink" title="准备二进制文件"></a>准备二进制文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/coreos/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">tar -vxf etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">cp etcd-v3.4.9-linux-amd64/etcd* /usr/bin/</span><br><span class="line">chmod +x /usr/bin/etcd*</span><br></pre></td></tr></table></figure>

<h4 id="部署环境变量"><a href="#部署环境变量" class="headerlink" title="部署环境变量"></a>部署环境变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> NODE_NAME=<span class="string">&quot;etcd-host1&quot;</span> <span class="comment">#当前部署的机器名称(随便定义，只要能区分不同机器即可)</span></span><br><span class="line"><span class="built_in">export</span> NODE_IP=<span class="string">&quot;192.168.31.48&quot;</span> <span class="comment"># 当前部署的机器 IP</span></span><br><span class="line"><span class="built_in">export</span> <span class="built_in">export</span> NODE_IPS=<span class="string">&quot;192.168.31.48 192.168.31.137 192.168.31.226&quot;</span> <span class="comment"># etcd 集群所有机器 IP</span></span><br><span class="line"><span class="comment"># etcd 集群间通信的IP和端口</span></span><br><span class="line"><span class="built_in">export</span> ETCD_NODES=<span class="string">&quot;etcd-host1=https://192.168.31.48:2380,etcd-host2=https://192.168.31.137:2380,etcd-host3=https://192.168.31.226:2380&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="创建etcd的systemd-unit文件"><a href="#创建etcd的systemd-unit文件" class="headerlink" title="创建etcd的systemd unit文件"></a>创建etcd的systemd unit文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/etcd  <span class="comment"># 必须先创建工作目录</span></span><br><span class="line">cat &gt; etcd.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Etcd Server</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string">Wants=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">WorkingDirectory=/var/lib/etcd/</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/etcd \\</span></span><br><span class="line"><span class="string">  --name=$&#123;NODE_NAME&#125; \\</span></span><br><span class="line"><span class="string">  --cert-file=/etc/etcd/ssl/etcd.pem \\</span></span><br><span class="line"><span class="string">  --key-file=/etc/etcd/ssl/etcd-key.pem \\</span></span><br><span class="line"><span class="string">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \\</span></span><br><span class="line"><span class="string">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\</span></span><br><span class="line"><span class="string">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span></span><br><span class="line"><span class="string">  --initial-advertise-peer-urls=https://$&#123;NODE_IP&#125;:2380 \\</span></span><br><span class="line"><span class="string">  --listen-peer-urls=https://$&#123;NODE_IP&#125;:2380 \\</span></span><br><span class="line"><span class="string">  --listen-client-urls=https://$&#123;NODE_IP&#125;:2379,http://127.0.0.1:2379 \\</span></span><br><span class="line"><span class="string">  --advertise-client-urls=https://$&#123;NODE_IP&#125;:2379 \\</span></span><br><span class="line"><span class="string">  --initial-cluster-token=etcd-cluster-0 \\</span></span><br><span class="line"><span class="string">  --initial-cluster=$&#123;ETCD_NODES&#125; \\</span></span><br><span class="line"><span class="string">  --initial-cluster-state=new \\</span></span><br><span class="line"><span class="string">  --data-dir=/var/lib/etcd</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">RestartSec=5</span></span><br><span class="line"><span class="string">LimitNOFILE=65536</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>–name：方便理解的节点名称，默认为 default，在集群中应该保持唯一，可以使用 hostname</li>
<li>–data-dir：服务运行数据保存的路径，默认为 ${name}.etcd</li>
<li>–snapshot-count：指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘</li>
<li>–heartbeat-interval：leader 多久发送一次心跳到 followers。默认值是 100ms</li>
<li>–eletion-timeout：重新投票的超时时间，如果 follow 在该时间间隔没有收到心跳包，会触发重新投票，默认为 1000 ms</li>
<li>–listen-peer-urls：和同伴通信的地址，比如 <a href="http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用">http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用</a> localhost！</li>
<li>–listen-client-urls：对外提供服务的地址：比如 <a href="http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和">http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和</a> etcd 交互</li>
<li>–advertise-client-urls：对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</li>
<li>–initial-advertise-peer-urls：该节点同伴监听地址，这个值会告诉集群中其他节点</li>
<li>–initial-cluster：集群中所有节点的信息，格式为 node1=<a href="http://ip1:2380,node2=http://ip2:2380,…。注意：这里的">http://ip1:2380,node2=http://ip2:2380,…。注意：这里的</a> node1 是节点的 –name 指定的名字；后面的 ip1:2380 是 –initial-advertise-peer-urls 指定的值</li>
<li>–initial-cluster-state：新建集群的时候，这个值为 new；假如已经存在的集群，这个值为 existing</li>
<li>–initial-cluster-token：创建集群的 token，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即使配置和之前一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成未知的错误</li>
</ul>
<h4 id="启动-etcd-服务"><a href="#启动-etcd-服务" class="headerlink" title="启动 etcd 服务"></a>启动 etcd 服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mv etcd.service /etc/systemd/system/</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure>

<h4 id="验证服务并配置etcdctl工具"><a href="#验证服务并配置etcdctl工具" class="headerlink" title="验证服务并配置etcdctl工具"></a>验证服务并配置etcdctl工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcdctl --endpoints=<span class="string">&quot;https://192.168.31.48:2379,https://192.168.31.137:2379,https://192.168.31.226:2379&quot;</span> --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br></pre></td></tr></table></figure>

<p>为了后续操作方便可配置alias</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> etcdctl=<span class="string">&#x27;etcdctl --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=&quot;https://192.168.31.48:2379,https://192.168.31.137:2379,https://192.168.31.226:2379&quot;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化master"><a href="#初始化master" class="headerlink" title="初始化master"></a>初始化master</h3><h4 id="创建master配置文件"><a href="#创建master配置文件" class="headerlink" title="创建master配置文件"></a>创建master配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/config.yaml  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="string"># 国内不能访问 Google，修改为阿里云</span></span><br><span class="line"><span class="string">imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">### etcd 配置及秘钥 ###</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  external:</span></span><br><span class="line"><span class="string">    endpoints:</span></span><br><span class="line"><span class="string">    - https://192.168.31.48:2379</span></span><br><span class="line"><span class="string">    - https://192.168.31.137:2379</span></span><br><span class="line"><span class="string">    - https://192.168.31.226:2379</span></span><br><span class="line"><span class="string">    caFile: /etc/etcd/ssl/ca.pem</span></span><br><span class="line"><span class="string">    certFile: /etc/etcd/ssl/etcd.pem</span></span><br><span class="line"><span class="string">    keyFile: /etc/etcd/ssl/etcd-key.pem</span></span><br><span class="line"><span class="string">    dataDir: /var/lib/etcd</span></span><br><span class="line"><span class="string">### calico 网络插件的子网 ###</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  podSubnet: &quot;10.0.0.0/16&quot;</span></span><br><span class="line"><span class="string">  serviceSubnet: &quot;10.96.0.0/12&quot;</span></span><br><span class="line"><span class="string">###k8s的版本###</span></span><br><span class="line"><span class="string">kubernetesVersion: 1.18.0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h4 id="初始化master-1"><a href="#初始化master-1" class="headerlink" title="初始化master"></a>初始化master</h4><p>可查看依赖的镜像版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images list --kubernetes-version=v1.18.0</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config /etc/kubernetes/config.yaml <span class="comment">#主节点进行初始化</span></span><br></pre></td></tr></table></figure>

<p>出现如下提示表示配置成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line">kubeadm join 192.168.31.226:6443 --token v7b8zo.5hc1au8vl96xqyie \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:908597386cd0311f24e2d7c95e40559e3137523078e69e1262643c6161abc10a</span><br></pre></td></tr></table></figure>

<p>如果出现如下错误，需要按照上图提示，配置kube/config</p>
<p><img src="/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/image-20200815180231821.png" alt="image-20200815180231821"></p>
<h5 id="多master初始化"><a href="#多master初始化" class="headerlink" title="多master初始化"></a>多master初始化</h5><p>如果希望部署多master需要用下面的配置文件，token和tokenTTL在初始化第一台master的时候注释掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/config.yaml  &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta1</span></span><br><span class="line"><span class="string"># 国内不能访问 Google，修改为阿里云</span></span><br><span class="line"><span class="string">imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">### etcd 配置及秘钥 ###</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  external:</span></span><br><span class="line"><span class="string">    endpoints:</span></span><br><span class="line"><span class="string">    - https://192.168.31.48:2379</span></span><br><span class="line"><span class="string">    - https://192.168.31.137:2379</span></span><br><span class="line"><span class="string">    - https://192.168.31.226:2379</span></span><br><span class="line"><span class="string">    caFile: /etc/etcd/ssl/ca.pem</span></span><br><span class="line"><span class="string">    certFile: /etc/etcd/ssl/etcd.pem</span></span><br><span class="line"><span class="string">    keyFile: /etc/etcd/ssl/etcd-key.pem</span></span><br><span class="line"><span class="string">    dataDir: /var/lib/etcd</span></span><br><span class="line"><span class="string">### calico 网络插件的子网 ###</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  podSubnet: &quot;10.0.0.0/16&quot;</span></span><br><span class="line"><span class="string">  serviceSubnet: &quot;10.96.0.0/12&quot;</span></span><br><span class="line"><span class="string">###k8s的版本###</span></span><br><span class="line"><span class="string">kubernetesVersion: 1.18.0</span></span><br><span class="line"><span class="string">######多master配置#######</span></span><br><span class="line"><span class="string">#下面的token是master1节点初始化完成后，join得到的token值</span></span><br><span class="line"><span class="string">token: &quot;1gddb4.cs1chtdrk5r9aa0i&quot;</span></span><br><span class="line"><span class="string">tokenTTL: &quot;0s&quot;</span></span><br><span class="line"><span class="string">#是kubeadm帮我们apiserver生成对外服务的证书用的。因为外部访问apiserver是通过负载均衡实现的，所以作为服务端提供的证书中应该写的hosts是负载均衡的地址。</span></span><br><span class="line"><span class="string">apiServerCertSANs:</span></span><br><span class="line"><span class="string">#允许访问apiserver的地址</span></span><br><span class="line"><span class="string">- 192.168.30.189 #apiserver的负载均衡ip，或者是slb的ip</span></span><br><span class="line"><span class="string">- k8s-master1</span></span><br><span class="line"><span class="string">- k8s-slave1</span></span><br><span class="line"><span class="string">- k8s-slave2</span></span><br><span class="line"><span class="string">- 192.168.31.48</span></span><br><span class="line"><span class="string">- 192.168.31.137</span></span><br><span class="line"><span class="string">- 192.168.31.226</span></span><br><span class="line"><span class="string">apiServerExtraArgs:</span></span><br><span class="line"><span class="string"> apiserver-count: &quot;3&quot;</span></span><br><span class="line"><span class="string"> endpoint-reconciler-type: lease</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="calico安装"><a href="#calico安装" class="headerlink" title="calico安装"></a>calico安装</h2><p>安装calico</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/v3.15/manifests/calico.yaml</span><br><span class="line">https://docs.projectcalico.org/manifests/calico-etcd.yaml</span><br><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure>

<p>查看节点启动详情，calico3个进程都启动完毕</p>
<p><img src="/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/image-20200815183600446.png" alt="image-20200815183600446"></p>
<h2 id="添加node节点"><a href="#添加node节点" class="headerlink" title="添加node节点"></a>添加node节点</h2><p>在另一台节点执行下面命令，加入集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.31.226:6443 --token v7b8zo.5hc1au8vl96xqyie     --discovery-token-ca-cert-hash sha256:908597386cd0311f24e2d7c95e40559e3137523078e69e1262643c6161abc10a</span><br></pre></td></tr></table></figure>

<p>出现如下提示表示加入成功</p>
<p><img src="/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/image-20200815181858759.png" alt="image-20200815181858759"></p>
<p>在master执行<code>kubectl get nodes</code>，看到node状态都是Ready表示搭建完成</p>
<p><img src="/2020/08/20/kubeadm%E6%90%AD%E5%BB%BAk8s-1-18/image-20200815183942023.png" alt="image-20200815183942023"></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/k8s/">k8s</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/10/19/goftp-125-Data-connection-already-open%E9%97%AE%E9%A2%98/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">goftp 125 Data connection already open问题</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/05/python%E5%88%86%E6%9E%90%E8%B1%86%E7%93%A3%E5%BD%B1%E8%AF%84/"><span class="level-item">python分析豆瓣影评</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "g92f6NC1D6E1hrdTFMyRcb87-9Nh9j0Va",
            appKey: "Ndgct3lUzY9D37skjARFEdDT",
            placeholder: "说些什么...",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/head.png" alt="郭海蓝"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">郭海蓝</p><p class="is-size-6 is-block">运维小白</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ShenZhen</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">13</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/guohailan" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/guohailan"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitee" href="https://gitee.com/guohailan"><i class="fab fa-github-alt"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:547585808@qq.com"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#docker-安装"><span class="level-left"><span class="level-item">1</span><span class="level-item">docker 安装</span></span></a></li><li><a class="level is-mobile" href="#kubernet-安装"><span class="level-left"><span class="level-item">2</span><span class="level-item">kubernet 安装</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装kubectl"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">安装kubectl</span></span></a></li><li><a class="level is-mobile" href="#准备证书"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">准备证书</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#准备证书管理工具"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">准备证书管理工具</span></span></a></li><li><a class="level is-mobile" href="#生成ETCD的TLS-秘钥和证书"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">生成ETCD的TLS 秘钥和证书</span></span></a></li><li><a class="level is-mobile" href="#创建ca证书请求"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">创建ca证书请求</span></span></a></li><li><a class="level is-mobile" href="#创建CA证书和私钥"><span class="level-left"><span class="level-item">2.2.4</span><span class="level-item">创建CA证书和私钥</span></span></a></li><li><a class="level is-mobile" href="#创建-etcd-证书签名请求"><span class="level-left"><span class="level-item">2.2.5</span><span class="level-item">创建 etcd 证书签名请求</span></span></a></li><li><a class="level is-mobile" href="#生成-etcd-证书和私钥"><span class="level-left"><span class="level-item">2.2.6</span><span class="level-item">生成 etcd 证书和私钥</span></span></a></li><li><a class="level is-mobile" href="#将证书拷贝到所有服务器的指定目录"><span class="level-left"><span class="level-item">2.2.7</span><span class="level-item">将证书拷贝到所有服务器的指定目录</span></span></a></li></ul></li><li><a class="level is-mobile" href="#安装ETCD"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">安装ETCD</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#准备二进制文件"><span class="level-left"><span class="level-item">2.3.1</span><span class="level-item">准备二进制文件</span></span></a></li><li><a class="level is-mobile" href="#部署环境变量"><span class="level-left"><span class="level-item">2.3.2</span><span class="level-item">部署环境变量</span></span></a></li><li><a class="level is-mobile" href="#创建etcd的systemd-unit文件"><span class="level-left"><span class="level-item">2.3.3</span><span class="level-item">创建etcd的systemd unit文件</span></span></a></li><li><a class="level is-mobile" href="#启动-etcd-服务"><span class="level-left"><span class="level-item">2.3.4</span><span class="level-item">启动 etcd 服务</span></span></a></li><li><a class="level is-mobile" href="#验证服务并配置etcdctl工具"><span class="level-left"><span class="level-item">2.3.5</span><span class="level-item">验证服务并配置etcdctl工具</span></span></a></li></ul></li><li><a class="level is-mobile" href="#初始化master"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">初始化master</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建master配置文件"><span class="level-left"><span class="level-item">2.4.1</span><span class="level-item">创建master配置文件</span></span></a></li><li><a class="level is-mobile" href="#多master初始化"><span class="level-left"><span class="level-item">2.4.2</span><span class="level-item">多master初始化</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#calico安装"><span class="level-left"><span class="level-item">3</span><span class="level-item">calico安装</span></span></a></li><li><a class="level is-mobile" href="#添加node节点"><span class="level-left"><span class="level-item">4</span><span class="level-item">添加node节点</span></span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/blog.png" alt="Hailan Blog" height="28"></a><p class="is-size-7"><span>&copy; 2020 Guo Hailan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdnjs.loli.net/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>